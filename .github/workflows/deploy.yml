name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          command_timeout: 10m
          script: |
            set -e

            APP_DIR="/etc/dokploy/applications/app-hack-back-end-feed-k88xup/code"
            IMAGE_NAME="silverav2:latest"
            SERVICE_NAME="app-hack-back-end-feed-k88xup"
            HTTPS_URL="https://github.com/innovatehubph/silverav2.git"
            SSH_URL="git@github.com:innovatehubph/silverav2.git"

            echo "==> Pulling latest code..."
            cd "$APP_DIR"
            git remote set-url origin "$HTTPS_URL"
            git fetch origin main
            git reset --hard origin/main
            git remote set-url origin "$SSH_URL"

            echo "==> Building Docker image..."
            docker build -t "$IMAGE_NAME" .

            echo "==> Updating swarm service..."
            docker service update --force --image "$IMAGE_NAME" "$SERVICE_NAME"

            echo "==> Waiting for health check..."
            sleep 10
            if curl -sf http://127.0.0.1:3865/api/health > /dev/null; then
              echo "==> Deployment successful!"
              curl -s http://127.0.0.1:3865/api/health
            else
              echo "==> WARNING: Health check failed, service may still be starting"
              docker service ps "$SERVICE_NAME" --no-trunc | head -5
              exit 1
            fi

            echo "==> Cleaning up old Docker images..."
            docker image prune -f --filter "until=24h"

      - name: Send success email
        if: success()
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "Deploy SUCCESS - Silvera v2 (${{ github.sha }})"
          to: innovatehubph@gmail.com
          from: Silvera CI/CD <${{ secrets.MAIL_USERNAME }}>
          body: |
            Deployment to production succeeded.

            Commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}
            Triggered by: ${{ github.actor }}
            Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Send failure email
        if: failure()
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "Deploy FAILED - Silvera v2 (${{ github.sha }})"
          to: innovatehubph@gmail.com
          from: Silvera CI/CD <${{ secrets.MAIL_USERNAME }}>
          body: |
            Deployment to production FAILED.

            Commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}
            Triggered by: ${{ github.actor }}
            Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please check the workflow logs for details.

      - name: Telegram notify (success)
        if: success()
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            BOT_TOKEN=$(python3 -c "import json; print(json.load(open('/root/.openclaw/openclaw.json'))['channels']['telegram']['botToken'])")
            CHAT_ID="1104423387"
            MSG="✅ *Deploy SUCCESS* — Silvera v2%0A%0ACommit: \`${GITHUB_SHA:0:7}\`%0ABranch: main%0ATriggered by: ${{ github.actor }}%0A[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            curl -sf "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="$CHAT_ID" \
              -d parse_mode=Markdown \
              -d text="$MSG"

      - name: Telegram notify (failure)
        if: failure()
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            BOT_TOKEN=$(python3 -c "import json; print(json.load(open('/root/.openclaw/openclaw.json'))['channels']['telegram']['botToken'])")
            CHAT_ID="1104423387"
            MSG="❌ *Deploy FAILED* — Silvera v2%0A%0ACommit: \`${GITHUB_SHA:0:7}\`%0ABranch: main%0ATriggered by: ${{ github.actor }}%0A[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})%0A%0ACheck logs for details."
            curl -sf "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="$CHAT_ID" \
              -d parse_mode=Markdown \
              -d text="$MSG"
